<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposi√ß√µes - CNMP</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>CNMP - Sistema de Acompanhamento de Proposi√ß√µes</h1>
        <div class="header-user">
            <span id="userName">Usu√°rio</span>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav>
                <div class="nav-item" onclick="window.location.href='index.html'">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="window.location.href='index.html#correicoes'">
                    <span class="nav-icon">üèõÔ∏è</span>
                    <span>Correi√ß√µes</span>
                </div>
                <div class="nav-item active" onclick="window.location.href='proposicoes.html'">
                    <span class="nav-icon">üìã</span>
                    <span>Proposi√ß√µes</span>
                </div>
                <div class="nav-item" id="navMinhasComprovacoes" onclick="window.location.href='index.html#enviar'" style="display: none;">
                    <span class="nav-icon">üì§</span>
                    <span>Minhas Comprova√ß√µes</span>
                </div>
                <div class="nav-item" id="navPublicar" onclick="window.location.href='index.html#publicar'">
                    <span class="nav-icon">üì¢</span>
                    <span>Publicar Proposi√ß√µes</span>
                </div>
                <div class="nav-item" id="navAvaliar" onclick="window.location.href='index.html#avaliar'">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>Avaliar Comprova√ß√µes</span>
                </div>
                <div class="nav-item" id="navCadastroCorreicao" onclick="window.location.href='index.html#cadastroCorreicao'">
                    <span class="nav-icon">‚ûï</span>
                    <span>Nova Correi√ß√£o</span>
                </div>
                <div class="nav-item" id="navCadastroProposicao" onclick="window.location.href='index.html#cadastro'">
                    <span class="nav-icon">‚úèÔ∏è</span>
                    <span>Nova Proposi√ß√£o</span>
                </div>
            </nav>
        </aside>

        <!-- Content -->
        <main class="content">
            <!-- Breadcrumb -->
            <div style="margin-bottom: 1.5rem;">
                <a href="index.html" style="color: var(--secondary-color); text-decoration: none;">‚Üê Voltar ao Dashboard</a>
            </div>

            <!-- Header com Bot√£o de Exporta√ß√£o -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 class="page-title" style="margin: 0;">Proposi√ß√µes</h2>

                <!-- Bot√£o de Exporta√ß√£o -->
                <div class="export-dropdown">
                    <button class="export-btn" onclick="toggleExportMenu('proposicoesExportMenu')">
                        üì• Exportar
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div id="proposicoesExportMenu" class="export-menu hidden">
                        <button onclick="exportarProposicoesPDF()" class="export-menu-item">
                            üìÑ Exportar Vis√£o Atual (PDF)
                        </button>
                        <button onclick="exportarProposicoesJSON()" class="export-menu-item">
                            üíæ Exportar Dados Filtrados (JSON)
                        </button>
                        <button onclick="exportarProposicoesRelatorioCompleto()" class="export-menu-item">
                            üìä Exportar Relat√≥rio Completo (PDF)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Seletor de Correi√ß√£o (Obrigat√≥rio) -->
            <div class="form-container" style="margin-bottom: 2rem;">
                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">1. Selecione a Correi√ß√£o</h3>
                <div class="form-group">
                    <label for="correicaoSelect">Correi√ß√£o *</label>
                    <select id="correicaoSelect" required onchange="onCorreicaoChange()">
                        <option value="">Selecione uma correi√ß√£o...</option>
                    </select>
                </div>

                <!-- Informa√ß√µes da Correi√ß√£o Selecionada -->
                <div id="correicaoInfo" class="hidden" style="margin-top: 1rem; padding: 1rem; background-color: var(--light-bg); border-radius: 4px; border-left: 4px solid var(--primary-color);">
                    <h4 style="color: var(--primary-color); margin-bottom: 0.5rem;">Informa√ß√µes da Correi√ß√£o</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div>
                            <strong>Tem√°tica:</strong>
                            <p id="infoTematica" style="margin: 0.25rem 0;"></p>
                        </div>
                        <div>
                            <strong>Per√≠odo:</strong>
                            <p id="infoPeriodo" style="margin: 0.25rem 0;"></p>
                        </div>
                        <div>
                            <strong>Total de Proposi√ß√µes:</strong>
                            <p id="infoTotalProposicoes" style="margin: 0.25rem 0;"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros e Busca Avan√ßada -->
            <div id="filtrosContainer" class="hidden">
                <div class="table-container" style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">2. Filtros e Busca Avan√ßada</h3>
                    <div class="table-header">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="üîç Buscar por n√∫mero, unidade, membro ou descri√ß√£o...">
                            <select id="tipoFilter">
                                <option value="">Todos os tipos</option>
                                <option value="Determina√ß√£o">Determina√ß√£o</option>
                                <option value="Recomenda√ß√£o">Recomenda√ß√£o</option>
                            </select>
                            <select id="statusFilter">
                                <option value="">Todos os status</option>
                                <optgroup label="Status Processual">
                                    <option value="pendente">Pendente</option>
                                    <option value="aguardando_comprovacao">Aguardando Comprova√ß√£o</option>
                                    <option value="em_analise">Em An√°lise</option>
                                    <option value="encerrada">Encerrada</option>
                                </optgroup>
                                <optgroup label="Valora√ß√£o">
                                    <option value="adimplente">Adimplente</option>
                                    <option value="parcial">Parcial</option>
                                    <option value="inadimplente">Inadimplente</option>
                                    <option value="prejudicada">Prejudicada</option>
                                </optgroup>
                            </select>
                            <select id="tagFilter">
                                <option value="">Todas as tags</option>
                            </select>
                            <select id="prioridadeFilter">
                                <option value="">Todas as prioridades</option>
                                <option value="urgente">Urgente</option>
                                <option value="alta">Alta</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 0.5rem;">
                        <button class="btn btn-secondary" onclick="limparFiltros()" style="font-size: 0.875rem;">
                            üîÑ Limpar Filtros
                        </button>
                    </div>
                </div>

                <!-- Tabela de Proposi√ß√µes -->
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary-color); margin: 0;">3. Lista de Proposi√ß√µes</h3>
                        <span id="resultadosCount" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 10%;">N√∫mero</th>
                                <th style="width: 10%;">Tipo</th>
                                <th style="width: 15%;">Unidade</th>
                                <th style="width: 25%;">Descri√ß√£o</th>
                                <th style="width: 12%;">Tags</th>
                                <th style="width: 13%;">Status</th>
                                <th style="width: 15%;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="proposicoesTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Placeholder quando nenhuma correi√ß√£o selecionada -->
            <div id="placeholderMessage" class="hidden" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <h3 style="color: var(--text-dark);">Selecione uma Correi√ß√£o</h3>
                <p>Para visualizar as proposi√ß√µes, primeiro selecione uma correi√ß√£o acima.</p>
            </div>
        </main>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes da Proposi√ß√£o</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <!-- Bot√£o de Exporta√ß√£o -->
                    <div class="export-dropdown">
                        <button class="export-btn" onclick="toggleExportMenu('detailModalExportMenu')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            üì•
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div id="detailModalExportMenu" class="export-menu hidden">
                            <button onclick="exportarDetalhePDF()" class="export-menu-item">
                                üìÑ Exportar Timeline (PDF)
                            </button>
                            <button onclick="exportarDetalheJSON()" class="export-menu-item">
                                üíæ Exportar Dados Completos (JSON)
                            </button>
                        </div>
                    </div>
                    <button class="btn-close" onclick="closeModal('detailModal')">&times;</button>
                </div>
            </div>
            <div id="detailContent">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Editar Proposi√ß√£o</h3>
                <button class="btn-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <form id="editForm" onsubmit="salvarEdicao(event)">
                <div class="form-group">
                    <label for="editNumero">N√∫mero da Proposi√ß√£o</label>
                    <input type="text" id="editNumero" readonly style="background-color: var(--light-bg);">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editTipo">Tipo *</label>
                        <select id="editTipo" required>
                            <option value="Determina√ß√£o">Determina√ß√£o</option>
                            <option value="Recomenda√ß√£o">Recomenda√ß√£o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPrioridade">Prioridade *</label>
                        <select id="editPrioridade" required>
                            <option value="urgente">Urgente</option>
                            <option value="alta">Alta</option>
                            <option value="normal">Normal</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editUnidade">Unidade Respons√°vel *</label>
                    <input type="text" id="editUnidade" required placeholder="Ex: Promotoria de Justi√ßa de Cachoeira">
                </div>

                <div class="form-group">
                    <label for="editMembro">Membro Respons√°vel *</label>
                    <input type="text" id="editMembro" required placeholder="Ex: Dr. Jo√£o Silva Santos">
                </div>

                <div class="form-group">
                    <label for="editDescricao">Descri√ß√£o da Proposi√ß√£o *</label>
                    <textarea id="editDescricao" required rows="6" maxlength="5000"></textarea>
                    <div class="textarea-counter">
                        <span class="char-count" id="editCharCount">0 / 5000 caracteres</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tags (Categorias)</label>
                    <div id="editTagSelectContainer" class="tag-select-container">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global data
        let correicoes = [];
        let proposicoes = [];
        let currentUser = null;
        let currentDetailProposicaoId = null; // ID da proposi√ß√£o sendo visualizada no modal

        // Available tags
        const availableTags = [
            { id: 'administrativo', label: 'Administrativo' },
            { id: 'recursos-humanos', label: 'Recursos Humanos' },
            { id: 'infraestrutura', label: 'Infraestrutura' },
            { id: 'tecnologia', label: 'Tecnologia' },
            { id: 'processual', label: 'Processual' },
            { id: 'financeiro', label: 'Financeiro' },
            { id: 'capacitacao', label: 'Capacita√ß√£o' },
            { id: 'gestao-documental', label: 'Gest√£o Documental' },
            { id: 'compliance', label: 'Compliance' },
            { id: 'transparencia', label: 'Transpar√™ncia' },
            { id: 'outros', label: 'Outros' }
        ];

        // Load data from localStorage
        function loadDataFromLocalStorage() {
            try {
                const correicoesData = localStorage.getItem('correicoes');
                const proposicoesData = localStorage.getItem('proposicoes');

                if (correicoesData) {
                    correicoes = JSON.parse(correicoesData);
                }

                if (proposicoesData) {
                    proposicoes = JSON.parse(proposicoesData);
                }

                return true;
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
                alert('Erro ao carregar dados. Redirecionando para a p√°gina principal.');
                window.location.href = 'index.html';
                return false;
            }
        }

        // Load user session
        function loadUserSession() {
            try {
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Erro ao carregar sess√£o do usu√°rio:', error);
                return false;
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        // Helper functions for bidimensional status model
        function getStatusLabel(status) {
            const labels = {
                // Conjunto 1: Status Processual
                'pendente': 'Pendente',
                'aguardando_comprovacao': 'Aguardando Comprova√ß√£o',
                'em_analise': 'Em An√°lise',
                'encerrada': 'Encerrada',
                // Conjunto 2: Valora√ß√£o
                'nova': 'Nova',
                'adimplente': 'Adimplente',
                'parcial': 'Parcial',
                'inadimplente': 'Inadimplente',
                'prejudicada': 'Prejudicada'
            };
            return labels[status] || status;
        }

        // Render status badges (stacked vertically)
        function renderStatusBadges(statusArray) {
            if (!Array.isArray(statusArray) || statusArray.length !== 2) {
                return '<span class="badge badge-pendente">Erro</span>';
            }
            const [statusProcessual, valoracao] = statusArray;
            return `
                <div class="status-badges-container">
                    <span class="badge badge-${statusProcessual}">${getStatusLabel(statusProcessual)}</span>
                    <span class="badge badge-${valoracao}">${getStatusLabel(valoracao)}</span>
                </div>
            `;
        }

        // Get status processual (index 0)
        function getStatusProcessual(proposicao) {
            return Array.isArray(proposicao.status) ? proposicao.status[0] : proposicao.status;
        }

        // Get valora√ß√£o (index 1)
        function getValoracao(proposicao) {
            return Array.isArray(proposicao.status) ? proposicao.status[1] : 'nova';
        }

        // Render tag badges
        function renderTagBadges(tags) {
            if (!tags || tags.length === 0) return '<span style="color: var(--text-muted); font-size: 0.75rem;">-</span>';

            return tags.map(tagId => {
                const tag = availableTags.find(t => t.id === tagId);
                const label = tag ? tag.label : tagId;
                return `<span class="tag-badge tag-${tagId}">${label}</span>`;
            }).join('');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Smart truncate
        function smartTruncate(text, maxLength) {
            if (!text || text.length <= maxLength) return text || '';
            return text.substring(0, maxLength) + '...';
        }

        // Get text length badge
        function getTextLengthBadge(text) {
            if (!text) return '';
            const length = text.length;
            if (length > 1000) {
                return `<span class="text-length-badge very-long">${length} caracteres</span>`;
            } else if (length > 500) {
                return `<span class="text-length-badge long">${length} caracteres</span>`;
            }
            return `<span class="text-length-badge">${length} caracteres</span>`;
        }

        // Populate correi√ß√£o select dropdown (mandatory selector)
        function populateCorreicaoSelect() {
            const select = document.getElementById('correicaoSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione uma correi√ß√£o...</option>' +
                correicoes.map(c => `<option value="${c.id}">${c.numero} - ${c.ramoMP} - ${c.ramoMPNome}</option>`).join('');
        }

        // Populate tag filter
        function populateTagFilter() {
            const select = document.getElementById('tagFilter');
            if (!select) return;

            select.innerHTML = '<option value="">Todas as tags</option>' +
                availableTags.map(tag => `<option value="${tag.id}">${tag.label}</option>`).join('');
        }

        // Handle correi√ß√£o selection change
        function onCorreicaoChange() {
            const correicaoId = document.getElementById('correicaoSelect').value;
            const correicaoInfo = document.getElementById('correicaoInfo');
            const filtrosContainer = document.getElementById('filtrosContainer');
            const placeholderMessage = document.getElementById('placeholderMessage');

            if (!correicaoId) {
                // No correi√ß√£o selected - show placeholder
                correicaoInfo.classList.add('hidden');
                filtrosContainer.classList.add('hidden');
                placeholderMessage.classList.remove('hidden');
                return;
            }

            // Correi√ß√£o selected - show info and filters
            const correicao = correicoes.find(c => c.id == correicaoId);
            if (!correicao) return;

            // Display correi√ß√£o information
            document.getElementById('infoTematica').textContent = correicao.tematica || 'N/A';
            document.getElementById('infoPeriodo').textContent = `${formatDate(correicao.dataInicio)} - ${formatDate(correicao.dataFim)}`;

            const totalProposicoes = proposicoes.filter(p => p.correicaoId == correicaoId).length;
            document.getElementById('infoTotalProposicoes').textContent = `${totalProposicoes} proposi√ß√£o(√µes)`;

            correicaoInfo.classList.remove('hidden');
            filtrosContainer.classList.remove('hidden');
            placeholderMessage.classList.add('hidden');

            // Render table with filtered propositions
            renderProposicoesTable();
        }

        // Clear all filters
        function limparFiltros() {
            document.getElementById('searchInput').value = '';
            document.getElementById('tipoFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('tagFilter').value = '';
            document.getElementById('prioridadeFilter').value = '';
            renderProposicoesTable();
        }

        // Render proposi√ß√µes table (NEW VERSION - 7 columns, 3 actions)
        function renderProposicoesTable() {
            const tbody = document.getElementById('proposicoesTableBody');
            const resultadosCount = document.getElementById('resultadosCount');
            if (!tbody) return;

            // Get selected correi√ß√£o (MANDATORY)
            const correicaoId = document.getElementById('correicaoSelect').value;
            if (!correicaoId) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Selecione uma correi√ß√£o para visualizar proposi√ß√µes</td></tr>';
                if (resultadosCount) resultadosCount.textContent = '';
                return;
            }

            // Get filter values
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tipoFilter = document.getElementById('tipoFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tagFilter = document.getElementById('tagFilter').value;
            const prioridadeFilter = document.getElementById('prioridadeFilter').value;

            // Filter propositions
            const filtered = proposicoes.filter(p => {
                // MANDATORY: Only show propositions from selected correi√ß√£o
                if (p.correicaoId != correicaoId) return false;

                // Search filter
                const searchText = `${p.numero} ${p.tipo} ${p.unidade} ${p.membro} ${p.descricao}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);

                // Tipo filter
                const matchesTipo = !tipoFilter || p.tipo === tipoFilter;

                // Status filter (check both statusProcessual and valora√ß√£o)
                let matchesStatus = true;
                if (statusFilter) {
                    const statusProcessual = getStatusProcessual(p);
                    const valoracao = getValoracao(p);
                    matchesStatus = statusProcessual === statusFilter || valoracao === statusFilter;
                }

                // Tag filter
                const matchesTag = !tagFilter || (p.tags && p.tags.includes(tagFilter));

                // Prioridade filter
                const matchesPrioridade = !prioridadeFilter || p.prioridade === prioridadeFilter;

                return matchesSearch && matchesTipo && matchesStatus && matchesTag && matchesPrioridade;
            });

            // Update results count
            if (resultadosCount) {
                resultadosCount.textContent = `${filtered.length} resultado(s) encontrado(s)`;
            }

            // Render table rows
            tbody.innerHTML = filtered.map(p => {
                const descPreview = smartTruncate(p.descricao, 100);

                return `
                    <tr>
                        <td><strong>${p.numero}</strong></td>
                        <td>${p.tipo}</td>
                        <td style="font-size: 0.875rem;">${p.unidade}</td>
                        <td style="font-size: 0.875rem;">
                            <div class="text-preview">
                                <span class="text-preview-content">${descPreview}</span>
                            </div>
                        </td>
                        <td>${renderTagBadges(p.tags)}</td>
                        <td>${renderStatusBadges(p.status)}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem; flex-wrap: wrap; justify-content: center;">
                                <button class="btn btn-primary btn-action" onclick="viewDetails(${p.id})" title="Ver todos os detalhes">
                                    üëÅÔ∏è Visualizar
                                </button>
                                <button class="btn btn-secondary btn-action" onclick="abrirAvaliacao(${p.id})" title="Adicionar nova avalia√ß√£o">
                                    ‚öñÔ∏è Avaliar
                                </button>
                                <button class="btn btn-secondary btn-action" onclick="abrirModalEdicao(${p.id})" title="Editar informa√ß√µes">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">Nenhuma proposi√ß√£o encontrada com os filtros aplicados</td></tr>';
            }
        }

        // View details modal
        function viewDetails(id) {
            const proposicao = proposicoes.find(p => p.id === id);
            if (!proposicao) return;

            // Armazenar ID para fun√ß√µes de exporta√ß√£o
            currentDetailProposicaoId = id;

            const correicao = correicoes.find(c => c.id === proposicao.correicaoId);
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');

            // Build timeline from historico
            let timelineHTML = '';
            if (proposicao.historico && proposicao.historico.length > 0) {
                timelineHTML = `
                    <div style="margin-top: 2rem;">
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Hist√≥rico de Intera√ß√µes</h4>
                        <div class="timeline">
                            ${proposicao.historico.map(h => {
                                const statusBadges = h.statusNovo ?
                                    (Array.isArray(h.statusNovo) ? renderStatusBadges(h.statusNovo) : `<span class="badge badge-${h.statusNovo}">${getStatusLabel(h.statusNovo)}</span>`) : '';

                                return `
                                    <div class="timeline-item">
                                        <div class="timeline-marker ${h.tipo}"></div>
                                        <div class="timeline-content ${h.tipo}">
                                            <div class="timeline-header">
                                                <strong>${h.tipo === 'publicacao' ? 'üì¢ Publica√ß√£o' : h.tipo === 'comprovacao' ? 'üì§ Comprova√ß√£o' : '‚öñÔ∏è Avalia√ß√£o'}</strong>
                                                <span class="timeline-date">${formatDate(h.data)}</span>
                                            </div>
                                            <div class="timeline-body">
                                                <p><strong>Usu√°rio:</strong> ${h.usuario}</p>
                                                <p>${h.descricao}</p>
                                                ${h.observacoes ? `<p><em>${h.observacoes}</em></p>` : ''}
                                                ${h.prazoComprovacao ? `<p><strong>Prazo de Comprova√ß√£o:</strong> ${formatDate(h.prazoComprovacao)}</p>` : ''}
                                                ${h.statusNovo ? `<p><strong>Novo Status:</strong> ${statusBadges}</p>` : ''}
                                                ${h.arquivos && h.arquivos.length > 0 ? `
                                                    <div class="timeline-files">
                                                        <strong>Arquivos:</strong>
                                                        ${h.arquivos.map(file => `<span class="timeline-file">üìé ${file}</span>`).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">N√∫mero:</span>
                    <span class="detail-value">${proposicao.numero}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Correi√ß√£o:</span>
                    <span class="detail-value">${correicao ? correicao.numero : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">√ìrg√£o Correicionado:</span>
                    <span class="detail-value">${correicao ? correicao.ramoMP : 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tipo:</span>
                    <span class="detail-value">${proposicao.tipo}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Unidade:</span>
                    <span class="detail-value">${proposicao.unidade}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Membro:</span>
                    <span class="detail-value">${proposicao.membro}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">${renderStatusBadges(proposicao.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Prioridade:</span>
                    <span class="detail-value">${proposicao.prioridade}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tags:</span>
                    <span class="detail-value">${renderTagBadges(proposicao.tags)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Descri√ß√£o:</span>
                    <span class="detail-value">${proposicao.descricao}</span>
                </div>
                ${proposicao.prazoComprovacao ? `
                    <div class="detail-row">
                        <span class="detail-label">Prazo de Comprova√ß√£o:</span>
                        <span class="detail-value">${formatDate(proposicao.prazoComprovacao)}</span>
                    </div>
                ` : ''}
                ${proposicao.dataPublicacao ? `
                    <div class="detail-row">
                        <span class="detail-label">Data de Publica√ß√£o:</span>
                        <span class="detail-value">${formatDate(proposicao.dataPublicacao)}</span>
                    </div>
                ` : ''}
                ${timelineHTML}
            `;

            modal.classList.remove('hidden');
        }

        // Open avaliacao page
        function abrirAvaliacao(id) {
            // Redirect to avaliacao.html with proposition ID
            window.location.href = `avaliacao.html?id=${id}`;
        }

        // Open edit modal
        function abrirModalEdicao(id) {
            const proposicao = proposicoes.find(p => p.id === id);
            if (!proposicao) return;

            // Populate form fields
            document.getElementById('editNumero').value = proposicao.numero;
            document.getElementById('editTipo').value = proposicao.tipo;
            document.getElementById('editPrioridade').value = proposicao.prioridade;
            document.getElementById('editUnidade').value = proposicao.unidade;
            document.getElementById('editMembro').value = proposicao.membro;
            document.getElementById('editDescricao').value = proposicao.descricao;

            // Update character counter
            updateCharCounter('editDescricao', 'editCharCount', 5000);

            // Populate tag checkboxes
            populateTagCheckboxes(proposicao.tags || []);

            // Store current proposition ID in form
            document.getElementById('editForm').dataset.proposicaoId = id;

            // Show modal
            document.getElementById('editModal').classList.remove('hidden');
        }

        // Populate tag checkboxes for edit modal
        function populateTagCheckboxes(selectedTags) {
            const container = document.getElementById('editTagSelectContainer');
            if (!container) return;

            container.innerHTML = availableTags.map(tag => {
                const checked = selectedTags.includes(tag.id) ? 'checked' : '';
                return `
                    <div class="tag-checkbox-item">
                        <input type="checkbox" name="tags" value="${tag.id}" ${checked} id="tag-${tag.id}">
                        <label for="tag-${tag.id}">
                            <span class="tag-badge tag-${tag.id}">${tag.label}</span>
                        </label>
                    </div>
                `;
            }).join('');
        }

        // Update character counter
        function updateCharCounter(textareaId, counterId, maxLength) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(counterId);
            if (!textarea || !counter) return;

            const length = textarea.value.length;
            counter.textContent = `${length} / ${maxLength} caracteres`;

            // Visual feedback
            if (length > maxLength * 0.9) {
                counter.style.color = 'var(--danger-color)';
            } else if (length > maxLength * 0.7) {
                counter.style.color = 'var(--warning-color)';
            } else {
                counter.style.color = 'var(--text-muted)';
            }
        }

        // Setup character counter for edit modal
        function setupEditCharCounter() {
            const textarea = document.getElementById('editDescricao');
            if (textarea) {
                textarea.addEventListener('input', () => {
                    updateCharCounter('editDescricao', 'editCharCount', 5000);
                });
            }
        }

        // Save edited proposition
        function salvarEdicao(event) {
            event.preventDefault();

            const form = document.getElementById('editForm');
            const proposicaoId = parseInt(form.dataset.proposicaoId);
            const proposicao = proposicoes.find(p => p.id === proposicaoId);

            if (!proposicao) {
                alert('Erro: Proposi√ß√£o n√£o encontrada.');
                return;
            }

            // Get selected tags
            const selectedTags = Array.from(document.querySelectorAll('#editTagSelectContainer input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            // Update proposition data
            proposicao.tipo = document.getElementById('editTipo').value;
            proposicao.prioridade = document.getElementById('editPrioridade').value;
            proposicao.unidade = document.getElementById('editUnidade').value;
            proposicao.membro = document.getElementById('editMembro').value;
            proposicao.descricao = document.getElementById('editDescricao').value;
            proposicao.tags = selectedTags;

            // Save to localStorage
            localStorage.setItem('proposicoes', JSON.stringify(proposicoes));

            // Show success message
            alert('‚úÖ Proposi√ß√£o atualizada com sucesso!');

            // Close modal and refresh table
            closeModal('editModal');
            renderProposicoesTable();
        }

        // Close modal (accepts modal ID)
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // ========== FUN√á√ïES DE EXPORTA√á√ÉO ==========

        // Toggle Export Menu
        function toggleExportMenu(menuId) {
            const menu = document.getElementById(menuId);
            const dropdown = menu.closest('.export-dropdown');

            // Close all other menus
            document.querySelectorAll('.export-menu').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.add('hidden');
                    m.closest('.export-dropdown')?.classList.remove('active');
                }
            });

            // Toggle current menu
            menu.classList.toggle('hidden');
            dropdown?.classList.toggle('active');
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.export-dropdown')) {
                document.querySelectorAll('.export-menu').forEach(menu => {
                    menu.classList.add('hidden');
                    menu.closest('.export-dropdown')?.classList.remove('active');
                });
            }
        });

        // Helper: Get filtered propositions
        function getProposicoesFiltradas() {
            const correicaoId = document.getElementById('correicaoSelect').value;
            if (!correicaoId) return [];

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tipoFilter = document.getElementById('tipoFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tagFilter = document.getElementById('tagFilter').value;
            const prioridadeFilter = document.getElementById('prioridadeFilter').value;

            return proposicoes.filter(p => {
                if (p.correicaoId != correicaoId) return false;

                const searchText = `${p.numero} ${p.tipo} ${p.unidade} ${p.membro} ${p.descricao}`.toLowerCase();
                const matchesSearch = searchText.includes(searchTerm);
                const matchesTipo = !tipoFilter || p.tipo === tipoFilter;

                let matchesStatus = true;
                if (statusFilter) {
                    const statusProcessual = getStatusProcessual(p);
                    const valoracao = getValoracao(p);
                    matchesStatus = statusProcessual === statusFilter || valoracao === statusFilter;
                }

                const matchesTag = !tagFilter || (p.tags && p.tags.includes(tagFilter));
                const matchesPrioridade = !prioridadeFilter || p.prioridade === prioridadeFilter;

                return matchesSearch && matchesTipo && matchesStatus && matchesTag && matchesPrioridade;
            });
        }

        // Exportar Proposi√ß√µes em JSON
        function exportarProposicoesJSON() {
            const filtered = getProposicoesFiltradas();
            if (filtered.length === 0) {
                alert('Nenhuma proposi√ß√£o para exportar. Selecione uma correi√ß√£o primeiro.');
                return;
            }

            const correicaoId = document.getElementById('correicaoSelect').value;
            const correicao = correicoes.find(c => c.id == correicaoId);

            const exportData = {
                titulo: 'Proposi√ß√µes CNMP - Exporta√ß√£o de Dados',
                dataExportacao: new Date().toISOString(),
                correicao: {
                    numero: correicao?.numero || '',
                    ramoMP: correicao?.ramoMPNome || '',
                    tematica: correicao?.tematica || '',
                    periodo: correicao ? `${formatDate(correicao.dataInicio)} a ${formatDate(correicao.dataFim)}` : ''
                },
                totalProposicoes: filtered.length,
                filtrosAplicados: {
                    busca: document.getElementById('searchInput').value || 'Nenhum',
                    tipo: document.getElementById('tipoFilter').value || 'Todos',
                    status: document.getElementById('statusFilter').value || 'Todos',
                    tag: document.getElementById('tagFilter').value || 'Todas',
                    prioridade: document.getElementById('prioridadeFilter').value || 'Todas'
                },
                usuario: currentUser ? `${currentUser.ramoMP} - ${currentUser.ramoMPNome}` : 'Admin',
                proposicoes: filtered
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `proposicoes-${correicao?.numero || 'export'}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            document.getElementById('proposicoesExportMenu').classList.add('hidden');
            alert('Dados de proposi√ß√µes exportados com sucesso em formato JSON!');
        }

        // Exportar Proposi√ß√µes em PDF (Vis√£o Atual)
        function exportarProposicoesPDF() {
            const filtered = getProposicoesFiltradas();
            if (filtered.length === 0) {
                alert('Nenhuma proposi√ß√£o para exportar. Selecione uma correi√ß√£o primeiro.');
                return;
            }

            const correicaoId = document.getElementById('correicaoSelect').value;
            const correicao = correicoes.find(c => c.id == correicaoId);

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Proposi√ß√µes - ${correicao?.numero || 'Export'}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #333;
                            font-size: 11px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #003366;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .header h1 {
                            color: #003366;
                            font-size: 20px;
                            margin-bottom: 5px;
                        }
                        .info {
                            background: #f8f9fa;
                            padding: 12px;
                            border-radius: 5px;
                            margin-bottom: 15px;
                            font-size: 11px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                        }
                        th, td {
                            padding: 8px 6px;
                            text-align: left;
                            border: 1px solid #ddd;
                            font-size: 10px;
                        }
                        th {
                            background: #003366;
                            color: white;
                            font-weight: 600;
                        }
                        tr:nth-child(even) {
                            background: #f8f9fa;
                        }
                        .footer {
                            margin-top: 20px;
                            padding-top: 10px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                        }
                        @media print {
                            body { padding: 10px; }
                            @page { size: landscape; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìã Proposi√ß√µes - ${correicao?.numero || ''}</h1>
                        <div style="color: #666; font-size: 12px;">${correicao?.ramoMPNome || ''}</div>
                    </div>

                    <div class="info">
                        <strong>Data:</strong> ${formatDate(new Date().toISOString().split('T')[0])} &nbsp;|&nbsp;
                        <strong>Tem√°tica:</strong> ${correicao?.tematica || '-'} &nbsp;|&nbsp;
                        <strong>Total:</strong> ${filtered.length} proposi√ß√£o(√µes)
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Tipo</th>
                                <th>Unidade</th>
                                <th>Descri√ß√£o</th>
                                <th>Tags</th>
                                <th>Status Processual</th>
                                <th>Valora√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(p => {
                                const statusProcessual = getStatusProcessual(p);
                                const valoracao = getValoracao(p);
                                const tagsText = p.tags && p.tags.length > 0
                                    ? p.tags.map(t => availableTags.find(at => at.id === t)?.label || t).join(', ')
                                    : '-';
                                const descPreview = smartTruncate(p.descricao, 150);

                                return `
                                <tr>
                                    <td><strong>${p.numero}</strong></td>
                                    <td>${p.tipo}</td>
                                    <td style="font-size: 9px;">${p.unidade}</td>
                                    <td style="font-size: 9px;">${descPreview}</td>
                                    <td style="font-size: 9px;">${tagsText}</td>
                                    <td>${getStatusLabel(statusProcessual)}</td>
                                    <td>${getStatusLabel(valoracao)}</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>

                    <div class="footer">
                        <p>Relat√≥rio gerado pelo Sistema NAD - CNMP | Conselho Nacional do Minist√©rio P√∫blico</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };

            document.getElementById('proposicoesExportMenu').classList.add('hidden');
        }

        // Exportar Proposi√ß√µes - Relat√≥rio Completo com Timeline
        function exportarProposicoesRelatorioCompleto() {
            const filtered = getProposicoesFiltradas();
            if (filtered.length === 0) {
                alert('Nenhuma proposi√ß√£o para exportar. Selecione uma correi√ß√£o primeiro.');
                return;
            }

            const correicaoId = document.getElementById('correicaoSelect').value;
            const correicao = correicoes.find(c => c.id == correicaoId);

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Relat√≥rio Completo - ${correicao?.numero || 'Proposi√ß√µes'}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #333;
                            line-height: 1.5;
                            font-size: 11px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #003366;
                            padding-bottom: 20px;
                            margin-bottom: 25px;
                        }
                        .header h1 {
                            color: #003366;
                            font-size: 22px;
                            margin-bottom: 8px;
                        }
                        .info-section {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #0066cc;
                            font-size: 11px;
                        }
                        .proposicao-block {
                            background: white;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                        .proposicao-header {
                            background: #003366;
                            color: white;
                            padding: 10px;
                            border-radius: 5px;
                            margin-bottom: 12px;
                        }
                        .proposicao-header h3 {
                            font-size: 14px;
                            margin-bottom: 3px;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 8px;
                            margin-bottom: 12px;
                            font-size: 10px;
                        }
                        .info-item {
                            padding: 6px;
                            background: #f8f9fa;
                            border-radius: 4px;
                        }
                        .info-item strong {
                            color: #003366;
                        }
                        .timeline {
                            margin-top: 12px;
                            padding-top: 12px;
                            border-top: 2px solid #e0e0e0;
                        }
                        .timeline h4 {
                            color: #003366;
                            font-size: 12px;
                            margin-bottom: 10px;
                        }
                        .timeline-item {
                            border-left: 3px solid #0066cc;
                            padding-left: 12px;
                            margin-bottom: 12px;
                            font-size: 10px;
                        }
                        .timeline-date {
                            font-weight: bold;
                            color: #0066cc;
                            margin-bottom: 3px;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #e0e0e0;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                        }
                        @media print {
                            body { padding: 15px; }
                            .proposicao-block { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä Relat√≥rio Completo de Proposi√ß√µes</h1>
                        <div style="color: #666; font-size: 13px;">${correicao?.numero || ''} - ${correicao?.ramoMPNome || ''}</div>
                    </div>

                    <div class="info-section">
                        <strong>Data:</strong> ${formatDate(new Date().toISOString().split('T')[0])} &nbsp;|&nbsp;
                        <strong>Tem√°tica:</strong> ${correicao?.tematica || '-'} &nbsp;|&nbsp;
                        <strong>Total:</strong> ${filtered.length} proposi√ß√£o(√µes)
                    </div>

                    ${filtered.map(p => {
                        const statusProcessual = getStatusProcessual(p);
                        const valoracao = getValoracao(p);
                        const tagsText = p.tags && p.tags.length > 0
                            ? p.tags.map(t => availableTags.find(at => at.id === t)?.label || t).join(', ')
                            : 'Nenhuma';

                        const timelineHTML = p.historico && p.historico.length > 0
                            ? `<div class="timeline">
                                <h4>üìú Hist√≥rico (${p.historico.length} intera√ß√µes)</h4>
                                ${p.historico.map(h => {
                                    let tipoLabel = 'Registro';
                                    if (h.tipo === 'publicacao') tipoLabel = 'üì§ Publica√ß√£o';
                                    else if (h.tipo === 'comprovacao') tipoLabel = 'üìé Comprova√ß√£o';
                                    else if (h.tipo === 'avaliacao') tipoLabel = '‚öñÔ∏è Avalia√ß√£o';

                                    return `
                                    <div class="timeline-item">
                                        <div class="timeline-date">${tipoLabel} - ${formatDate(h.data)}</div>
                                        <div><strong>Por:</strong> ${h.usuario}</div>
                                        <div>${h.descricao}</div>
                                        ${h.observacoes ? `<div><em>Obs: ${h.observacoes}</em></div>` : ''}
                                        ${h.prazoComprovacao ? `<div><strong>Prazo:</strong> ${formatDate(h.prazoComprovacao)}</div>` : ''}
                                        ${h.arquivos && h.arquivos.length > 0 ? `<div><strong>Arquivos:</strong> ${h.arquivos.join(', ')}</div>` : ''}
                                    </div>
                                    `;
                                }).join('')}
                            </div>`
                            : '';

                        return `
                        <div class="proposicao-block">
                            <div class="proposicao-header">
                                <h3>${p.numero} - ${p.tipo}</h3>
                                <div style="font-size: 11px;">${p.unidade}</div>
                            </div>

                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>Membro:</strong> ${p.membro || '-'}
                                </div>
                                <div class="info-item">
                                    <strong>Prioridade:</strong> ${p.prioridade || 'normal'}
                                </div>
                                <div class="info-item">
                                    <strong>Status Processual:</strong> ${getStatusLabel(statusProcessual)}
                                </div>
                                <div class="info-item">
                                    <strong>Valora√ß√£o:</strong> ${getStatusLabel(valoracao)}
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <strong>Tags:</strong> ${tagsText}
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <strong>Descri√ß√£o:</strong> ${p.descricao || '-'}
                                </div>
                            </div>

                            ${timelineHTML}
                        </div>
                        `;
                    }).join('')}

                    <div class="footer">
                        <p>Relat√≥rio gerado automaticamente pelo Sistema NAD - CNMP</p>
                        <p>Conselho Nacional do Minist√©rio P√∫blico</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };

            document.getElementById('proposicoesExportMenu').classList.add('hidden');
        }

        // ========== FUN√á√ïES DE EXPORTA√á√ÉO - MODAL DE DETALHES ==========

        // Exportar Detalhes da Proposi√ß√£o em JSON
        function exportarDetalheJSON() {
            if (!currentDetailProposicaoId) {
                alert('Erro: Nenhuma proposi√ß√£o selecionada.');
                return;
            }

            const proposicao = proposicoes.find(p => p.id === currentDetailProposicaoId);
            if (!proposicao) {
                alert('Erro: Proposi√ß√£o n√£o encontrada.');
                return;
            }

            const correicao = correicoes.find(c => c.id === proposicao.correicaoId);

            const exportData = {
                titulo: 'Proposi√ß√£o CNMP - Dados Completos',
                dataExportacao: new Date().toISOString(),
                proposicao: {
                    ...proposicao,
                    correicao: {
                        numero: correicao?.numero || '',
                        ramoMP: correicao?.ramoMPNome || '',
                        tematica: correicao?.tematica || '',
                        periodo: correicao ? `${formatDate(correicao.dataInicio)} a ${formatDate(correicao.dataFim)}` : ''
                    }
                },
                usuario: currentUser ? `${currentUser.ramoMP} - ${currentUser.ramoMPNome}` : 'Corregedoria Nacional (Admin)'
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `proposicao-${proposicao.numero}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            document.getElementById('detailModalExportMenu').classList.add('hidden');
            alert('Dados da proposi√ß√£o exportados com sucesso em formato JSON!');
        }

        // Exportar Detalhes da Proposi√ß√£o em PDF (Timeline)
        function exportarDetalhePDF() {
            if (!currentDetailProposicaoId) {
                alert('Erro: Nenhuma proposi√ß√£o selecionada.');
                return;
            }

            const proposicao = proposicoes.find(p => p.id === currentDetailProposicaoId);
            if (!proposicao) {
                alert('Erro: Proposi√ß√£o n√£o encontrada.');
                return;
            }

            const correicao = correicoes.find(c => c.id === proposicao.correicaoId);
            const statusProcessual = getStatusProcessual(proposicao);
            const valoracao = getValoracao(proposicao);

            const tagsText = proposicao.tags && proposicao.tags.length > 0
                ? proposicao.tags.map(t => availableTags.find(at => at.id === t)?.label || t).join(', ')
                : 'Nenhuma';

            const timelineHTML = proposicao.historico && proposicao.historico.length > 0
                ? proposicao.historico.map(h => {
                    let tipoLabel = 'Registro';
                    let tipoIcon = 'üìù';
                    if (h.tipo === 'publicacao') { tipoLabel = 'Publica√ß√£o'; tipoIcon = 'üì§'; }
                    else if (h.tipo === 'comprovacao') { tipoLabel = 'Comprova√ß√£o'; tipoIcon = 'üìé'; }
                    else if (h.tipo === 'avaliacao') { tipoLabel = 'Avalia√ß√£o'; tipoIcon = '‚öñÔ∏è'; }

                    return `
                    <div class="timeline-item ${h.tipo}">
                        <div class="timeline-header">
                            <strong>${tipoIcon} ${tipoLabel}</strong>
                            <span style="float: right; color: #666;">${formatDate(h.data)}</span>
                        </div>
                        <div class="timeline-content">
                            <div><strong>Por:</strong> ${h.usuario}</div>
                            <div style="margin-top: 0.5rem;">${h.descricao}</div>
                            ${h.observacoes ? `<div style="margin-top: 0.5rem;"><em><strong>Observa√ß√µes:</strong> ${h.observacoes}</em></div>` : ''}
                            ${h.prazoComprovacao ? `<div style="margin-top: 0.5rem;"><strong>Prazo de Comprova√ß√£o:</strong> ${formatDate(h.prazoComprovacao)}</div>` : ''}
                            ${h.statusAnterior && h.statusNovo ? `<div style="margin-top: 0.5rem;"><strong>Mudan√ßa de Status:</strong> ${getStatusLabel(h.statusAnterior)} ‚Üí ${getStatusLabel(h.statusNovo)}</div>` : ''}
                            ${h.arquivos && h.arquivos.length > 0 ? `<div style="margin-top: 0.5rem;"><strong>Arquivos:</strong> ${h.arquivos.join(', ')}</div>` : ''}
                        </div>
                    </div>
                    `;
                }).join('')
                : '<p style="text-align: center; color: #999;">Nenhum hist√≥rico dispon√≠vel</p>';

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Proposi√ß√£o ${proposicao.numero} - Detalhes Completos</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 25px;
                            color: #333;
                            line-height: 1.6;
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #003366;
                            padding-bottom: 20px;
                            margin-bottom: 25px;
                        }
                        .header h1 {
                            color: #003366;
                            font-size: 22px;
                            margin-bottom: 5px;
                        }
                        .header .subtitle {
                            color: #666;
                            font-size: 13px;
                        }
                        .info-section {
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #0066cc;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin-bottom: 10px;
                        }
                        .info-item {
                            padding: 8px;
                            background: white;
                            border-radius: 4px;
                            border: 1px solid #e0e0e0;
                        }
                        .info-item strong {
                            color: #003366;
                            display: block;
                            margin-bottom: 3px;
                            font-size: 11px;
                        }
                        .info-item.full-width {
                            grid-column: 1 / -1;
                        }
                        .section-title {
                            color: #003366;
                            font-size: 16px;
                            margin: 25px 0 15px 0;
                            padding-bottom: 8px;
                            border-bottom: 2px solid #0066cc;
                        }
                        .timeline-item {
                            border-left: 4px solid #0066cc;
                            padding: 12px;
                            margin-bottom: 15px;
                            background: #f8f9fa;
                            border-radius: 4px;
                            page-break-inside: avoid;
                        }
                        .timeline-item.publicacao {
                            border-left-color: #fd7e14;
                            background: #fff3cd;
                        }
                        .timeline-item.comprovacao {
                            border-left-color: #0066cc;
                            background: #e7f3ff;
                        }
                        .timeline-item.avaliacao {
                            border-left-color: #28a745;
                            background: #d4edda;
                        }
                        .timeline-header {
                            font-size: 13px;
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #ddd;
                        }
                        .timeline-content {
                            font-size: 11px;
                            line-height: 1.7;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 2px solid #e0e0e0;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                        }
                        @media print {
                            body { padding: 15px; }
                            .timeline-item { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìã Proposi√ß√£o ${proposicao.numero}</h1>
                        <div class="subtitle">${proposicao.tipo} - ${correicao?.ramoMPNome || ''}</div>
                    </div>

                    <div class="info-section">
                        <div class="info-grid">
                            <div class="info-item">
                                <strong>Correi√ß√£o:</strong>
                                ${correicao?.numero || '-'} - ${correicao?.ramoMPNome || '-'}
                            </div>
                            <div class="info-item">
                                <strong>Per√≠odo:</strong>
                                ${correicao ? `${formatDate(correicao.dataInicio)} a ${formatDate(correicao.dataFim)}` : '-'}
                            </div>
                            <div class="info-item">
                                <strong>Unidade:</strong>
                                ${proposicao.unidade || '-'}
                            </div>
                            <div class="info-item">
                                <strong>Membro:</strong>
                                ${proposicao.membro || '-'}
                            </div>
                            <div class="info-item">
                                <strong>Prioridade:</strong>
                                ${proposicao.prioridade?.toUpperCase() || 'NORMAL'}
                            </div>
                            <div class="info-item">
                                <strong>Status:</strong>
                                ${getStatusLabel(statusProcessual)} | ${getStatusLabel(valoracao)}
                            </div>
                            <div class="info-item full-width">
                                <strong>Tags:</strong>
                                ${tagsText}
                            </div>
                            <div class="info-item full-width">
                                <strong>Descri√ß√£o:</strong>
                                ${proposicao.descricao || '-'}
                            </div>
                        </div>
                    </div>

                    <h2 class="section-title">üìú Hist√≥rico Completo (${proposicao.historico?.length || 0} intera√ß√µes)</h2>
                    ${timelineHTML}

                    <div class="footer">
                        <p>Relat√≥rio gerado automaticamente pelo Sistema NAD - CNMP</p>
                        <p>Conselho Nacional do Minist√©rio P√∫blico</p>
                        <p>Data de gera√ß√£o: ${formatDate(new Date().toISOString().split('T')[0])}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();

            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };

            document.getElementById('detailModalExportMenu').classList.add('hidden');
        }

        // Initialize page
        function init() {
            // Load user session
            if (!loadUserSession()) {
                alert('Sess√£o expirada. Por favor, fa√ßa login novamente.');
                window.location.href = 'index.html';
                return;
            }

            // Display user name
            document.getElementById('userName').textContent = currentUser.username;

            // Show/hide menu items based on user type
            if (currentUser.type === 'user') {
                document.getElementById('navMinhasComprovacoes').style.display = 'flex';
                document.getElementById('navPublicar').style.display = 'none';
                document.getElementById('navAvaliar').style.display = 'none';
                document.getElementById('navCadastroCorreicao').style.display = 'none';
                document.getElementById('navCadastroProposicao').style.display = 'none';
            } else {
                document.getElementById('navMinhasComprovacoes').style.display = 'none';
            }

            // Load data
            if (!loadDataFromLocalStorage()) {
                return;
            }

            // Populate correi√ß√£o selector
            populateCorreicaoSelect();

            // Populate tag filter
            populateTagFilter();

            // Show placeholder initially (no correi√ß√£o selected)
            document.getElementById('placeholderMessage').classList.remove('hidden');
            document.getElementById('filtrosContainer').classList.add('hidden');
            document.getElementById('correicaoInfo').classList.add('hidden');

            // Setup character counter for edit modal
            setupEditCharCounter();

            // Add event listeners for filters
            document.getElementById('searchInput').addEventListener('input', renderProposicoesTable);
            document.getElementById('tipoFilter').addEventListener('change', renderProposicoesTable);
            document.getElementById('statusFilter').addEventListener('change', renderProposicoesTable);
            document.getElementById('tagFilter').addEventListener('change', renderProposicoesTable);
            document.getElementById('prioridadeFilter').addEventListener('change', renderProposicoesTable);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
